// ============================================================
// ArcticOS - Framebuffer Driver
// VESA/VBE 32bpp support, pixel/rect/text drawing
// ============================================================

#include "../include/kernel.h"

// ============================================================
// 8x8 FONT (IBM PC 437, minimal ASCII 32-127 set)
// Each character is 8 bytes (8 rows of 8 bits)
// ============================================================
static const u8 font8x8[128][8] = {
    [' '] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    ['!'] = {0x18,0x18,0x18,0x18,0x00,0x00,0x18,0x00},
    ['"'] = {0x66,0x66,0x24,0x00,0x00,0x00,0x00,0x00},
    ['#'] = {0x36,0x36,0x7F,0x36,0x7F,0x36,0x36,0x00},
    ['$'] = {0x0C,0x3E,0x03,0x1E,0x30,0x1F,0x0C,0x00},
    ['%'] = {0x00,0x63,0x33,0x18,0x0C,0x66,0x63,0x00},
    ['&'] = {0x1C,0x36,0x1C,0x6E,0x3B,0x33,0x6E,0x00},
    ['\'']= {0x06,0x06,0x03,0x00,0x00,0x00,0x00,0x00},
    ['('] = {0x18,0x0C,0x06,0x06,0x06,0x0C,0x18,0x00},
    [')'] = {0x06,0x0C,0x18,0x18,0x18,0x0C,0x06,0x00},
    ['*'] = {0x00,0x66,0x3C,0xFF,0x3C,0x66,0x00,0x00},
    ['+'] = {0x00,0x0C,0x0C,0x3F,0x0C,0x0C,0x00,0x00},
    [','] = {0x00,0x00,0x00,0x00,0x00,0x0C,0x0C,0x06},
    ['-'] = {0x00,0x00,0x00,0x3F,0x00,0x00,0x00,0x00},
    ['.'] = {0x00,0x00,0x00,0x00,0x00,0x0C,0x0C,0x00},
    ['/'] = {0x60,0x30,0x18,0x0C,0x06,0x03,0x01,0x00},
    ['0'] = {0x3E,0x63,0x73,0x7B,0x6F,0x67,0x3E,0x00},
    ['1'] = {0x0C,0x0E,0x0C,0x0C,0x0C,0x0C,0x3F,0x00},
    ['2'] = {0x1E,0x33,0x30,0x1C,0x06,0x33,0x3F,0x00},
    ['3'] = {0x1E,0x33,0x30,0x1C,0x30,0x33,0x1E,0x00},
    ['4'] = {0x38,0x3C,0x36,0x33,0x7F,0x30,0x78,0x00},
    ['5'] = {0x3F,0x03,0x1F,0x30,0x30,0x33,0x1E,0x00},
    ['6'] = {0x1C,0x06,0x03,0x1F,0x33,0x33,0x1E,0x00},
    ['7'] = {0x3F,0x33,0x30,0x18,0x0C,0x0C,0x0C,0x00},
    ['8'] = {0x1E,0x33,0x33,0x1E,0x33,0x33,0x1E,0x00},
    ['9'] = {0x1E,0x33,0x33,0x3E,0x30,0x18,0x0E,0x00},
    [':'] = {0x00,0x0C,0x0C,0x00,0x00,0x0C,0x0C,0x00},
    [';'] = {0x00,0x0C,0x0C,0x00,0x00,0x0C,0x0C,0x06},
    ['<'] = {0x18,0x0C,0x06,0x03,0x06,0x0C,0x18,0x00},
    ['='] = {0x00,0x00,0x3F,0x00,0x00,0x3F,0x00,0x00},
    ['>'] = {0x06,0x0C,0x18,0x30,0x18,0x0C,0x06,0x00},
    ['?'] = {0x1E,0x33,0x30,0x18,0x0C,0x00,0x0C,0x00},
    ['@'] = {0x3E,0x63,0x7B,0x7B,0x7B,0x03,0x1E,0x00},
    ['A'] = {0x0C,0x1E,0x33,0x33,0x3F,0x33,0x33,0x00},
    ['B'] = {0x3F,0x66,0x66,0x3E,0x66,0x66,0x3F,0x00},
    ['C'] = {0x3C,0x66,0x03,0x03,0x03,0x66,0x3C,0x00},
    ['D'] = {0x1F,0x36,0x66,0x66,0x66,0x36,0x1F,0x00},
    ['E'] = {0x7F,0x46,0x16,0x1E,0x16,0x46,0x7F,0x00},
    ['F'] = {0x7F,0x46,0x16,0x1E,0x16,0x06,0x0F,0x00},
    ['G'] = {0x3C,0x66,0x03,0x03,0x73,0x66,0x7C,0x00},
    ['H'] = {0x33,0x33,0x33,0x3F,0x33,0x33,0x33,0x00},
    ['I'] = {0x1E,0x0C,0x0C,0x0C,0x0C,0x0C,0x1E,0x00},
    ['J'] = {0x78,0x30,0x30,0x30,0x33,0x33,0x1E,0x00},
    ['K'] = {0x67,0x66,0x36,0x1E,0x36,0x66,0x67,0x00},
    ['L'] = {0x0F,0x06,0x06,0x06,0x46,0x66,0x7F,0x00},
    ['M'] = {0x63,0x77,0x7F,0x7F,0x6B,0x63,0x63,0x00},
    ['N'] = {0x63,0x67,0x6F,0x7B,0x73,0x63,0x63,0x00},
    ['O'] = {0x1C,0x36,0x63,0x63,0x63,0x36,0x1C,0x00},
    ['P'] = {0x3F,0x66,0x66,0x3E,0x06,0x06,0x0F,0x00},
    ['Q'] = {0x1E,0x33,0x33,0x33,0x3B,0x1E,0x38,0x00},
    ['R'] = {0x3F,0x66,0x66,0x3E,0x36,0x66,0x67,0x00},
    ['S'] = {0x1E,0x33,0x07,0x0E,0x38,0x33,0x1E,0x00},
    ['T'] = {0x3F,0x2D,0x0C,0x0C,0x0C,0x0C,0x1E,0x00},
    ['U'] = {0x33,0x33,0x33,0x33,0x33,0x33,0x3F,0x00},
    ['V'] = {0x33,0x33,0x33,0x33,0x33,0x1E,0x0C,0x00},
    ['W'] = {0x63,0x63,0x63,0x6B,0x7F,0x77,0x63,0x00},
    ['X'] = {0x63,0x63,0x36,0x1C,0x1C,0x36,0x63,0x00},
    ['Y'] = {0x33,0x33,0x33,0x1E,0x0C,0x0C,0x1E,0x00},
    ['Z'] = {0x7F,0x63,0x31,0x18,0x4C,0x66,0x7F,0x00},
    ['['] = {0x1E,0x06,0x06,0x06,0x06,0x06,0x1E,0x00},
    ['\\']= {0x03,0x06,0x0C,0x18,0x30,0x60,0x40,0x00},
    [']'] = {0x1E,0x18,0x18,0x18,0x18,0x18,0x1E,0x00},
    ['^'] = {0x08,0x1C,0x36,0x63,0x00,0x00,0x00,0x00},
    ['_'] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF},
    ['`'] = {0x0C,0x0C,0x18,0x00,0x00,0x00,0x00,0x00},
    ['a'] = {0x00,0x00,0x1E,0x30,0x3E,0x33,0x6E,0x00},
    ['b'] = {0x07,0x06,0x06,0x3E,0x66,0x66,0x3B,0x00},
    ['c'] = {0x00,0x00,0x1E,0x33,0x03,0x33,0x1E,0x00},
    ['d'] = {0x38,0x30,0x30,0x3e,0x33,0x33,0x6E,0x00},
    ['e'] = {0x00,0x00,0x1E,0x33,0x3f,0x03,0x1E,0x00},
    ['f'] = {0x1C,0x36,0x06,0x0f,0x06,0x06,0x0F,0x00},
    ['g'] = {0x00,0x00,0x6E,0x33,0x33,0x3E,0x30,0x1F},
    ['h'] = {0x07,0x06,0x36,0x6E,0x66,0x66,0x67,0x00},
    ['i'] = {0x0C,0x00,0x0E,0x0C,0x0C,0x0C,0x1E,0x00},
    ['j'] = {0x30,0x00,0x30,0x30,0x30,0x33,0x33,0x1E},
    ['k'] = {0x07,0x06,0x66,0x36,0x1E,0x36,0x67,0x00},
    ['l'] = {0x0E,0x0C,0x0C,0x0C,0x0C,0x0C,0x1E,0x00},
    ['m'] = {0x00,0x00,0x33,0x7F,0x7F,0x6B,0x63,0x00},
    ['n'] = {0x00,0x00,0x1F,0x33,0x33,0x33,0x33,0x00},
    ['o'] = {0x00,0x00,0x1E,0x33,0x33,0x33,0x1E,0x00},
    ['p'] = {0x00,0x00,0x3B,0x66,0x66,0x3E,0x06,0x0F},
    ['q'] = {0x00,0x00,0x6E,0x33,0x33,0x3E,0x30,0x78},
    ['r'] = {0x00,0x00,0x3B,0x6E,0x66,0x06,0x0F,0x00},
    ['s'] = {0x00,0x00,0x3E,0x03,0x1E,0x30,0x1F,0x00},
    ['t'] = {0x08,0x0C,0x3E,0x0C,0x0C,0x2C,0x18,0x00},
    ['u'] = {0x00,0x00,0x33,0x33,0x33,0x33,0x6E,0x00},
    ['v'] = {0x00,0x00,0x33,0x33,0x33,0x1E,0x0C,0x00},
    ['w'] = {0x00,0x00,0x63,0x6B,0x7F,0x7F,0x36,0x00},
    ['x'] = {0x00,0x00,0x63,0x36,0x1C,0x36,0x63,0x00},
    ['y'] = {0x00,0x00,0x33,0x33,0x33,0x3E,0x30,0x1F},
    ['z'] = {0x00,0x00,0x3F,0x19,0x0C,0x26,0x3F,0x00},
    ['{'] = {0x38,0x0C,0x0C,0x07,0x0C,0x0C,0x38,0x00},
    ['|'] = {0x18,0x18,0x18,0x00,0x18,0x18,0x18,0x00},
    ['}'] = {0x07,0x0C,0x0C,0x38,0x0C,0x0C,0x07,0x00},
    ['~'] = {0x6E,0x3B,0x00,0x00,0x00,0x00,0x00,0x00},
};

// ============================================================
// FRAMEBUFFER INIT - Multiboot 1
// ============================================================
void fb_init(multiboot_info_t *mbi) {
    fb.addr         = (u32 *)(u32)mbi->framebuffer_addr;
    fb.pitch        = mbi->framebuffer_pitch;
    fb.width        = mbi->framebuffer_width;
    fb.height       = mbi->framebuffer_height;
    fb.bpp          = mbi->framebuffer_bpp;
    fb.pitch_pixels = mbi->framebuffer_pitch / 4;
}

// ============================================================
// FRAMEBUFFER INIT - Multiboot 2
// Parses MB2 tags and finds framebuffer tag (type=8)
// ============================================================
void fb_init_mb2(mb2_info_t *mb2) {
    // Tags start 8 bytes after the MB2 structure
    u8 *tag_ptr = (u8 *)mb2 + 8;
    u8 *end_ptr = (u8 *)mb2 + mb2->total_size;

    while (tag_ptr < end_ptr) {
        mb2_tag_t *tag = (mb2_tag_t *)tag_ptr;

        if (tag->type == 0) break;  // end tag

        if (tag->type == 8) {
            // Framebuffer tag
            mb2_tag_framebuffer_t *fbtag = (mb2_tag_framebuffer_t *)tag;
            fb.addr         = (u32 *)(u32)fbtag->framebuffer_addr;
            fb.pitch        = fbtag->framebuffer_pitch;
            fb.width        = fbtag->framebuffer_width;
            fb.height       = fbtag->framebuffer_height;
            fb.bpp          = fbtag->framebuffer_bpp;
            fb.pitch_pixels = fbtag->framebuffer_pitch / 4;
            return;
        }

        // Next tag - align to 8 bytes
        u32 next = (tag->size + 7) & ~7u;
        tag_ptr += next;
    }

    // Fallback if tag not found - default values
    fb.addr         = (u32 *)0xFD000000;
    fb.pitch        = 3200;
    fb.width        = 800;
    fb.height       = 600;
    fb.bpp          = 32;
    fb.pitch_pixels = 800;
}

// ============================================================
// BASIC PIXEL OPERATIONS
// Byte-addressed (correct for any bpp and pitch)
// ============================================================
void fb_put_pixel(int x, int y, u32 color) {
    if (x < 0 || y < 0 || (u32)x >= fb.width || (u32)y >= fb.height)
        return;

    u8 *base = (u8 *)fb.addr;

    if (fb.bpp == 32) {
        u32 *p = (u32 *)(base + (u32)y * fb.pitch + (u32)x * 4);
        *p = color;
    } else if (fb.bpp == 24) {
        u8 *p = base + (u32)y * fb.pitch + (u32)x * 3;
        p[0] = (u8)(color);
        p[1] = (u8)(color >> 8);
        p[2] = (u8)(color >> 16);
    } else if (fb.bpp == 16) {
        u8  r5 = (u8)((color >> 16) & 0xFF) >> 3;
        u8  g6 = (u8)((color >>  8) & 0xFF) >> 2;
        u8  b5 = (u8)((color >>  0) & 0xFF) >> 3;
        u16 px = (u16)((r5 << 11) | (g6 << 5) | b5);
        u16 *p = (u16 *)(base + (u32)y * fb.pitch + (u32)x * 2);
        *p = px;
    }
}

void fb_clear(u32 color) {
    for (u32 y = 0; y < fb.height; y++)
        for (u32 x = 0; x < fb.width; x++)
            fb_put_pixel((int)x, (int)y, color);
}

void fb_fill_rect(int x, int y, int w, int h, u32 color) {
    for (int row = y; row < y + h; row++)
        for (int col = x; col < x + w; col++)
            fb_put_pixel(col, row, color);
}

void fb_draw_rect(int x, int y, int w, int h, u32 color, int thickness) {
    for (int t = 0; t < thickness; t++) {
        // Top and bottom edges
        for (int col = x; col < x + w; col++) {
            fb_put_pixel(col, y + t, color);
            fb_put_pixel(col, y + h - 1 - t, color);
        }
        // Left and right edges
        for (int row = y; row < y + h; row++) {
            fb_put_pixel(x + t, row, color);
            fb_put_pixel(x + w - 1 - t, row, color);
        }
    }
}

void fb_draw_line(int x0, int y0, int x1, int y1, u32 color) {
    int dx = x1 - x0; if (dx < 0) dx = -dx;
    int dy = y1 - y0; if (dy < 0) dy = -dy;
    int sx = (x0 < x1) ? 1 : -1;
    int sy = (y0 < y1) ? 1 : -1;
    int err = dx - dy;
    while (1) {
        fb_put_pixel(x0, y0, color);
        if (x0 == x1 && y0 == y1) break;
        int e2 = 2 * err;
        if (e2 > -dy) { err -= dy; x0 += sx; }
        if (e2 <  dx) { err += dx; y0 += sy; }
    }
}

void fb_fill_circle(int cx, int cy, int r, u32 color) {
    for (int y = -r; y <= r; y++)
        for (int x = -r; x <= r; x++)
            if (x*x + y*y <= r*r)
                fb_put_pixel(cx + x, cy + y, color);
}

// ============================================================
// TEXT RENDERING (8x8 font, scalable)
// ============================================================
void fb_draw_char(int x, int y, char c, u32 fg, u32 bg, int scale) {
    unsigned char uc = (unsigned char)c;
    if (uc >= 128) uc = '?';
    const u8 *glyph = font8x8[uc];

    for (int row = 0; row < 8; row++) {
        for (int col = 0; col < 8; col++) {
            // Horizontal flip: read bit from right (LSB) instead of left (MSB)
            u32 pixel_color = (glyph[row] & (0x01 << col)) ? fg : bg;
            for (int sy = 0; sy < scale; sy++)
                for (int sx = 0; sx < scale; sx++)
                    fb_put_pixel(x + col*scale + sx, y + row*scale + sy, pixel_color);
        }
    }
}

void fb_draw_string(int x, int y, const char *s, u32 fg, u32 bg, int scale) {
    int cur_x = x;
    while (*s) {
        fb_draw_char(cur_x, y, *s, fg, bg, scale);
        cur_x += 8 * scale;
        s++;
    }
}
